<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <link rel="stylesheet" href="style.css" />
    <title>Scan Files - DetRan</title>
    <style>
        /* Minimal styles for log badge and sidebar */
        .log-badge {
            background:#ef4444;
            color:#fff;
            padding:2px 6px;
            border-radius:10px;
            font-size:12px;
            margin-left:6px;
        }

        .no-logs { color:#cbd5e1; }

        /* Right logs sidebar */
        .logs-sidebar {
            position: fixed;
            top: 0;
            right: -500px; /* hidden by default — offset updated for wider sidebar */
            width: 420px; /* increased width from 340px */
            height: 100vh;
            background: #020617;
            border-left: 1px solid rgba(148,163,184,0.35);
            box-shadow: -4px 0 20px rgba(15,23,42,0.95);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            transition: right 0.28s ease;
        }
        .logs-sidebar.open {
            right: 0;
        }
        .logs-sidebar-header {
            display:flex;
            align-items:center;
            justify-content:space-between;
            padding:14px 16px;
            border-bottom:1px solid rgba(148,163,184,0.35);
            background: rgba(15,23,42,0.95);
        }
        .logs-sidebar-header h3 {
            margin:0;
            font-size:16px;
            letter-spacing:0.03em;
            text-transform:uppercase;
            color:#e5e7eb;
        }
        .logs-close-btn {
            background:transparent;
            border:none;
            color:#9ca3af;
            font-size:18px;
            cursor:pointer;
            line-height:1;
        }
        .logs-close-btn:hover {
            color:#f97373;
        }
        .logs-sidebar-body {
            flex:1;
            overflow-y:auto;
            padding:10px 16px 14px;
        }
        .logs-sidebar-footer {
            padding:10px 16px 14px;
            border-top:1px solid rgba(148,163,184,0.35);
            display:flex;
            gap:8px;
            justify-content:flex-end;
            background: rgba(15,23,42,0.98);
        }

        .logs-sidebar-footer button {
            padding:6px 10px;
            border-radius:6px;
            border:none;
            cursor:pointer;
            font-size:12px;
            font-weight:500;
        }
        .btn-export { background:#34d399; color:#020617; }
        .btn-clear { background:#ef4444; color:#fff; }
        .btn-close { background:#111827; color:#fff; }
    </style>
</head>
<body>
    <!-- Animated Background Particles -->
    <div class="particles" id="particles"></div>

    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="logo">
                <a href="index.html" style="display: flex; align-items: center; gap: 0.5rem; text-decoration: none;">
                    <svg class="logo-icon" width="24" height="24" viewBox="0 0 24 24">
                        <path fill="currentColor" d="M12,1L3,5V11C3,16.55 6.84,21.74 12,23C17.16,21.74 21,16.55 21,11V5L12,1M12,7C13.4,7 14.8,8.6 14.8,10V11.5C15.4,11.5 16,12.1 16,12.7V16.5C16,17.1 15.4,17.7 14.8,17.7H9.2C8.6,17.7 8,17.1 8,16.5V12.6C8,12 8.6,11.4 9.2,11.4V10C9.2,8.6 10.6,7 12,7M12,8.2C11.2,8.2 10.5,8.7 10.5,9.5V11.5H13.5V9.5C13.5,8.7 12.8,8.2 12,8.2Z"/>
                    </svg>
                    <span class="logo-text">DETRAN</span>
                </a>
            </div>
            <ul class="nav-links">
                <li><a href="index.html" class="nav-link">HOME</a></li>
                <li><a href="scan.html" class="nav-link active">SCAN</a></li>
                <li><a href="index.html#features" class="nav-link">FEATURES</a></li>
                <li><a href="index.html#about" class="nav-link">ABOUT</a></li>
                <li><a href="index.html#contact" class="nav-link">CONTACT</a></li>
                <!-- NEW: Logs menu -->
                <li><a href="#" id="logsLink" class="nav-link">LOGS <span id="logsCount" class="log-badge" style="display:none;">0</span></a></li>
            </ul>
            <button class="mobile-toggle" id="mobileToggle">
                <span></span><span></span><span></span>
            </button>
        </div>
    </nav>

    <!-- Scan Page Content -->
    <section class="scan-page">
        <div class="scan-container">
            <div class="scan-header">
                <div class="scan-badge">THREAT DETECTION</div>
                <h1 class="scan-title">SCAN YOUR FILES</h1>
                <p class="scan-subtitle">Upload your files to detect ransomware and malicious threats using our AI-powered analysis engine</p>
            </div>

            <!-- Upload Section -->
            <div class="upload-section">
                <div class="upload-area" id="uploadArea">
                    <div class="upload-icon">
                        <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="17 8 12 3 7 8"></polyline>
                            <line x1="12" y1="3" x2="12" y2="15"></line>
                        </svg>
                    </div>
                    <h3 class="upload-title">Drop files here or click to browse</h3>
                    <p class="upload-subtitle">Supports all file types • Max 100MB per file</p>
                </div>

                <div class="upload-options">
                    <button class="upload-option-btn" id="filesBtn">
                        <svg width="20" height="20" viewBox="0 0 24 24">
                            <path fill="currentColor" d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
                        </svg>
                        <span>Select Files</span>
                    </button>
                    <button class="upload-option-btn" id="folderBtn">
                        <svg width="20" height="20" viewBox="0 0 24 24">
                            <path fill="currentColor" d="M10,4H4C2.89,4 2,4.89 2,6V18A2,2 0 0,0 4,20H20A2,2 0 0,0 22,18V8C22,6.89 21.1,6 20,6H12L10,4Z"/>
                        </svg>
                        <span>Select Folder</span>
                    </button>
                </div>

                <input type="file" class="file-input" id="fileInput" multiple>
                <input type="file" class="file-input" id="folderInput" webkitdirectory>
                
                <div class="file-list" id="fileList"></div>
                
                <button class="btn-primary scan-btn" id="scanBtn" style="display: none;">
                    <svg class="btn-icon" width="20" height="20" viewBox="0 0 24 24">
                        <path fill="currentColor" d="M15.5,14L20.5,19L19,20.5L14,15.5V14.71L13.73,14.43C12.59,15.41 11.11,16 9.5,16A6.5,6.5 0 0,1 3,9.5A6.5,6.5 0 0,1 9.5,3A6.5,6.5 0 0,1 16,9.5C16,11.11 15.41,12.59 14.43,13.73L14.71,14H15.5M9.5,14C12,14 14,12 14,9.5C14,7 12,5 9.5,5C7,5 5,7 5,9.5C5,12 7,14 9.5,14Z"/>
                    </svg>
                    <span>SCAN FILES FOR THREATS</span>
                    <span class="btn-glow"></span>
                </button>
            </div>

            <!-- Security Info Cards -->
            <div class="security-info">
                <div class="info-card">
                    <svg class="info-icon" width="32" height="32" viewBox="0 0 24 24">
                        <path fill="currentColor" d="M12,17A2,2 0 0,0 14,15C14,13.89 13.1,13 12,13A2,2 0 0,0 10,15A2,2 0 0,0 12,17M18,8A2,2 0 0,1 20,10V20A2,2 0 0,1 18,22H6A2,2 0 0,1 4,20V10C4,8.89 4.9,8 6,8H7V6A5,5 0 0,1 12,1A5,5 0 0,1 17,6V8H18M12,3A3,3 0 0,0 9,6V8H15V6A3,3 0 0,0 12,3Z"/>
                    </svg>
                    <h4>Secure Processing</h4>
                    <p>All files are encrypted and processed securely</p>
                </div>
                <div class="info-card">
                    <svg class="info-icon" width="32" height="32" viewBox="0 0 24 24">
                        <path fill="currentColor" d="M13.5,8H12V13L16.28,15.54L17,14.33L13.5,12.25V8M13,3A9,9 0 0,0 4,12H1L4.96,16.03L9,12H6A7,7 0 0,1 13,5A7,7 0 0,1 20,12A7,7 0 0,1 13,19C11.07,19 9.32,18.21 8.06,16.94L6.64,18.36C8.27,20 10.5,21 13,21A9,9 0 0,0 22,12A9,9 0 0,0 13,3"/>
                    </svg>
                    <h4>Fast Analysis</h4>
                    <p>Results delivered in seconds with high accuracy</p>
                </div>
                <div class="info-card">
                    <svg class="info-icon" width="32" height="32" viewBox="0 0 24 24">
                        <path fill="currentColor" d="M9,3V4H4V6H5V19A2,2 0 0,0 7,21H17A2,2 0 0,0 19,19V6H20V4H15V3H9M7,6H17V19H7V6M9,8V17H11V8H9M13,8V17H15V8H13Z"/>
                    </svg>
                    <h4>Auto Delete</h4>
                    <p>Files automatically deleted after scanning</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-content">
            <div class="footer-logo">
                <svg class="logo-icon" width="24" height="24" viewBox="0 0 24 24">
                    <path fill="currentColor" d="M12,1L3,5V11C3,16.55 6.84,21.74 12,23C17.16,21.74 21,16.55 21,11V5L12,1M12,7C13.4,7 14.8,8.6 14.8,10V11.5C15.4,11.5 16,12.1 16,12.7V16.5C16,17.1 15.4,17.7 14.8,17.7H9.2C8.6,17.7 8,17.1 8,16.5V12.6C8,12 8.6,11.4 9.2,11.4V10C9.2,8.6 10.6,7 12,7M12,8.2C11.2,8.2 10.5,8.7 10.5,9.5V11.5H13.5V9.5C13.5,8.7 12.8,8.2 12,8.2Z"/>
                </svg>
                <span class="logo-text">DETRAN</span>
            </div>
            <p class="footer-text">© 2024 DetRan. All rights reserved. Protecting your digital world.</p>
        </div>
    </footer>

    <!-- Scanning Overlay -->
    <div class="scanning-overlay" id="scanningOverlay">
        <div class="scanning-content">
            <div class="scanner-wrapper">
                <div class="scanner-ring"></div>
                <div class="scanner-ring"></div>
                <div class="scanner-ring"></div>
                <div class="scanner-center">
                    <svg width="48" height="48" viewBox="0 0 24 24">
                        <path fill="currentColor" d="M15.5,14L20.5,19L19,20.5L14,15.5V14.71L13.73,14.43C12.59,15.41 11.11,16 9.5,16A6.5,6.5 0 0,1 3,9.5A6.5,6.5 0 0,1 9.5,3A6.5,6.5 0 0,1 16,9.5C16,11.11 15.41,12.59 14.43,13.73L14.71,14H15.5M9.5,14C12,14 14,12 14,9.5C14,7 12,5 9.5,5C7,5 5,7 5,9.5C5,12 7,14 9.5,14Z"/>
                    </svg>
                </div>
            </div>
            <h3 class="scanning-text">SCANNING FILES...</h3>
            <p class="scanning-subtext">Analyzing for potential threats</p>
            <div class="progress-bar">
                <div class="progress-fill"></div>
            </div>
        </div>
    </div>

    <!-- Logs Sidebar -->
    <aside class="logs-sidebar" id="logsSidebar">
        <div class="logs-sidebar-header">
            <h3>Logs</h3>
            <button class="logs-close-btn" id="closeLogsSidebar" aria-label="Close logs">✕</button>
        </div>
        <div class="logs-sidebar-body" id="logsSidebarBody">
            <!-- log entries injected via JS -->
        </div>
        <div class="logs-sidebar-footer">
            <button class="btn-export" id="exportLogsBtn">Export JSON</button>
            <button class="btn-clear" id="clearLogsBtn">Clear logs</button>
        </div>
    </aside>

    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <!-- Main JavaScript -->
    <script>
        // Particle Animation
        function createParticles() {
            const particles = document.getElementById('particles');
            const particleCount = 50;
            for (let i = 0; i < particleCount; i++) {
                const p = document.createElement('div');
                p.className = 'particle';
                p.style.left = Math.random() * 100 + '%';
                p.style.top = Math.random() * 100 + '%';
                p.style.animationDelay = Math.random() * 20 + 's';
                p.style.animationDuration = (Math.random() * 10 + 10) + 's';
                particles.appendChild(p);
            }
        }

        // Mobile Menu Toggle
        const mobileToggle = document.getElementById('mobileToggle');
        const navLinks = document.querySelector('.nav-links');
        mobileToggle.addEventListener('click', () => {
            navLinks.classList.toggle('active');
            mobileToggle.classList.toggle('active');
        });

        // File Upload Logic
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const folderInput = document.getElementById('folderInput');
        const filesBtn = document.getElementById('filesBtn');
        const folderBtn = document.getElementById('folderBtn');
        const fileList = document.getElementById('fileList');
        const scanBtn = document.getElementById('scanBtn');
        const scanningOverlay = document.getElementById('scanningOverlay');

        let files = [];

        filesBtn.addEventListener('click', () => fileInput.click());
        folderBtn.addEventListener('click', () => folderInput.click());
        uploadArea.addEventListener('click', () => fileInput.click());

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('drag-over');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('drag-over');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('drag-over');
            handleFiles(e.dataTransfer.files);
        });

        fileInput.addEventListener('change', (e) => {
            handleFiles(e.target.files);
            fileInput.value = '';
        });

        folderInput.addEventListener('change', (e) => {
            handleFiles(e.target.files);
            folderInput.value = '';
        });

        function handleFiles(selectedFiles) {
            Array.from(selectedFiles).forEach(file => {
                if (!files.some(f => f.name === file.name)) {
                    files.push(file);
                    addFileToList(file);
                }
            });
            if (files.length > 0) {
                scanBtn.style.display = 'flex';
                setTimeout(() => scanBtn.classList.add('show'), 10);
            }
        }

        function addFileToList(file) {
            const item = document.createElement('div');
            item.className = 'file-item';
            const info = document.createElement('div');
            info.className = 'file-info';

            const icon = document.createElement('div');
            icon.className = 'file-icon-badge';
            icon.innerHTML = getFileIcon(file.name);

            const details = document.createElement('div');
            details.className = 'file-details';

            const name = document.createElement('div');
            name.className = 'file-name';
            name.textContent = file.name;

            const size = document.createElement('div');
            size.className = 'file-size';
            size.textContent = formatFileSize(file.size);

            details.appendChild(name);
            details.appendChild(size);
            info.appendChild(icon);
            info.appendChild(details);

            const removeBtn = document.createElement('button');
            removeBtn.className = 'file-remove';
            removeBtn.innerHTML = '✕';
            removeBtn.onclick = () => removeFile(file, item);

            item.appendChild(info);
            item.appendChild(removeBtn);

            fileList.insertBefore(item, fileList.firstChild);
            setTimeout(() => item.classList.add('show'), 10);
        }

        function removeFile(file, element) {
            files = files.filter(f => f !== file);
            element.classList.remove('show');
            setTimeout(() => {
                if (fileList.contains(element)) fileList.removeChild(element);
                if (files.length === 0) {
                    scanBtn.classList.remove('show');
                    setTimeout(() => scanBtn.style.display = 'none', 300);
                }
            }, 300);
        }

        function getFileIcon(fileName) {
            const ext = fileName.split('.').pop().toLowerCase();
            const icons = {
                pdf: '<svg width="20" height="20" viewBox="0 0 24 24"><path fill="currentColor" d="M5,4H15L20,9V19A2,2 0 0,1 18,21H5A2,2 0 0,1 3,19V5A2,2 0 0,1 5,3M5,5V19H18V10H13V5H5Z"/></svg>',
                // ... other icons omitted for brevity ...
            };
            return icons[ext] || '<svg width="20" height="20" viewBox="0 0 24 24"><path fill="currentColor" d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/></svg>';
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }

        // --------------------
        // LOGS: localStorage-based
        // --------------------
        const LOGS_KEY = 'detran_delete_logs';

        function loadLogs() {
            try {
                const raw = localStorage.getItem(LOGS_KEY);
                if (!raw) return [];
                return JSON.parse(raw);
            } catch (e) {
                console.error('Failed to load logs', e);
                return [];
            }
        }

        function saveLogs(logs) {
            try {
                localStorage.setItem(LOGS_KEY, JSON.stringify(logs));
                updateLogsCount();
            } catch (e) {
                console.error('Failed to save logs', e);
            }
        }

        // Log deletion entries
        function addDeletedLogs(deletedFiles) {
            if (!Array.isArray(deletedFiles) || deletedFiles.length === 0) return;

            const nowIst = new Date().toLocaleString('en-IN', {
                timeZone: 'Asia/Kolkata',
                hour12: false
            });

            const logs = loadLogs();
            deletedFiles.forEach(name => {
                logs.push({ file: name, action: 'deleted', at: nowIst });
            });
            saveLogs(logs);
        }

        // Log quarantine entries
        function addQuarantineLogs(quarantinedFiles) {
            if (!Array.isArray(quarantinedFiles) || quarantinedFiles.length === 0) return;

            const nowIst = new Date().toLocaleString('en-IN', {
                timeZone: 'Asia/Kolkata',
                hour12: false
            });

            const logs = loadLogs();
            quarantinedFiles.forEach(name => {
                logs.push({ file: name, action: 'quarantined', at: nowIst });
            });
            saveLogs(logs);
        }

        // NEW: Log safe/scanned entries
        function addSafeLogs(safeFiles) {
            if (!Array.isArray(safeFiles) || safeFiles.length === 0) return;

            const nowIst = new Date().toLocaleString('en-IN', {
                timeZone: 'Asia/Kolkata',
                hour12: false
            });

            const logs = loadLogs();
            safeFiles.forEach(name => {
                logs.push({ file: name, action: 'safe', at: nowIst });
            });
            saveLogs(logs);
        }

        function updateLogsCount() {
            const logs = loadLogs();
            const countEl = document.getElementById('logsCount');
            if (!countEl) return;
            if (logs.length === 0) {
                countEl.style.display = 'none';
            } else {
                countEl.style.display = 'inline-block';
                countEl.textContent = logs.length;
            }
        }

        function formatLogEntry(e) {
            const action = (e.action || 'deleted').toLowerCase();
            const when = e.at || e.deleted_at || '';
            let label = 'Deleted at';
            let timeColor = '#cbd5e1';

            if (action === 'quarantined') {
                label = 'Quarantined at';
                timeColor = '#fbbf24';
            } else if (action === 'safe') {
                label = 'Scanned at';
                timeColor = '#86efac';
            }

            return `<div style="padding:8px 0; border-bottom:1px solid rgba(255,255,255,0.04);">
                        <div style="font-weight:600;">${escapeHtml(e.file)}</div>
                        <div style="font-size:12px; color:${timeColor};">${label}: ${escapeHtml(when)}</div>
                    </div>`;
        }

        function escapeHtml(str){
            if(!str) return '';
            return str.replace(/[&<>'"]/g, function(tag){
                const chars = {'&':'&amp;','<':'&lt;','>':'&gt;',"'":'&#39;','"':'&quot;'};
                return chars[tag] || tag;
            });
        }

        // Show logs in the right sidebar instead of a popup
        function showLogsModal() {
            const logs = loadLogs();
            const sidebar = document.getElementById('logsSidebar');
            const body = document.getElementById('logsSidebarBody');

            if (!sidebar || !body) return;

            if (logs.length === 0) {
                body.innerHTML = `<p class="no-logs">No deleted or quarantined file records found.</p>`;
            } else {
                const listHtml = logs.map(formatLogEntry).reverse().join('');
                body.innerHTML = listHtml;
            }

            sidebar.classList.add('open');
        }

        function exportLogs() {
            const logs = loadLogs();
            const blob = new Blob([JSON.stringify(logs, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);

            const nowIst = new Date().toLocaleString('en-IN', {
                timeZone: 'Asia/Kolkata',
                hour12: false
            });
            const safeTs = nowIst.replace(/[/:, ]/g, '-'); // make it filename-safe

            const a = document.createElement('a');
            a.href = url;
            a.download = `detran_delete_logs_${safeTs}.json`;
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);
        }

        // Attach sidebar controls
        const logsSidebar = document.getElementById('logsSidebar');
        const logsSidebarBody = document.getElementById('logsSidebarBody');
        const closeLogsSidebarBtn = document.getElementById('closeLogsSidebar');
        const exportLogsBtn = document.getElementById('exportLogsBtn');
        const clearLogsBtn = document.getElementById('clearLogsBtn');

        function hideLogsSidebar() {
            if (logsSidebar) logsSidebar.classList.remove('open');
        }

        if (closeLogsSidebarBtn) {
            closeLogsSidebarBtn.addEventListener('click', hideLogsSidebar);
        }

        if (exportLogsBtn) {
            exportLogsBtn.addEventListener('click', exportLogs);
        }

        if (clearLogsBtn) {
            clearLogsBtn.addEventListener('click', () => {
                Swal.fire({
                    title: 'Clear all logs?',
                    text: 'This will permanently remove all local deleted/quarantined file records.',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Yes, clear',
                    cancelButtonText: 'Cancel',
                    background: '#1a1a2e',
                    color: '#fff'
                }).then(r => {
                    if (r.isConfirmed) {
                        localStorage.removeItem(LOGS_KEY);
                        updateLogsCount();
                        if (logsSidebarBody) {
                            logsSidebarBody.innerHTML = `<p class="no-logs">No deleted or quarantined file records found.</p>`;
                        }
                    }
                });
            });
        }

        // --------------------
        // Scan + Delete / Quarantine logic
        // --------------------

        // Scan Files
        scanBtn.addEventListener('click', async () => {
            if (files.length === 0) return;
            scanningOverlay.classList.add('active');

            const formData = new FormData();
            files.forEach(file => formData.append("file", file));

            try {
                const uploadRes = await fetch("http://localhost:5000/upload", {
                    method: "POST",
                    body: formData
                });

                const uploaded = await uploadRes.json();
                // map to backend-expected paths for scanning
                const filePaths = uploaded.saved.map(name => `uploads/${name}`);

                const scanRes = await fetch("http://localhost:5000/scan_selected", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ files: filePaths })
                });

                const scanResult = await scanRes.json();
                scanningOverlay.classList.remove('active');
                showScanResults(scanResult);

            } catch (err) {
                scanningOverlay.classList.remove('active');
                Swal.fire({
                    title: "Connection problem",
                    text: "Can't reach the backend. Is the Flask server running on localhost:5000?",
                    icon: "error",
                    confirmButtonText: "OK",
                    confirmButtonColor: "#ef4444",
                    background: "#1a1a2e",
                    color: "#fff"
                });
            }
        });

        // Build human-friendly reason string for why a file was flagged
        function buildFlagReasons(file) {
            const reasons = [];
            if (file.clamav) reasons.push("ClamAV");
            if (file.yara) reasons.push("YARA");
            if (file.high_entropy) reasons.push("High entropy");
            if (reasons.length === 0) return "Flagged (unknown reason)";
            return reasons.join(",");
        }

        // Show scan results and offer delete/quarantine actions
        function showScanResults(result) {
            // record safe files (those present in result.files with infected: false)
            try {
                if (Array.isArray(result.files)) {
                    const safeFiles = result.files
                        .filter(f => !f.infected)
                        .map(f => f.file || (f.path ? f.path.split('/').pop() : null))
                        .filter(Boolean);
                    // Log safe scans (new feature)
                    if (safeFiles.length > 0) {
                        addSafeLogs(safeFiles);
                    }
                }
            } catch (e) {
                console.warn('Could not record safe files', e);
            }

            const infected = result.files.filter(f => f.infected === true);

            if (infected.length > 0) {
                let fileListHTML = "<ul style='text-align:left; margin: 15px 0; padding-left: 20px;'>";
                infected.forEach(file => {
                    const reasons = buildFlagReasons(file);
                    const displayName = file.file || file.path || file.path?.split('/').pop();
                    fileListHTML += `<li style='margin: 8px 0;'><b>${displayName}</b> — <small style="color:#fca5a5">${reasons}</small></li>`;
                });
                fileListHTML += "</ul>";

                Swal.fire({
                    title: "Threats found",
                    html: `
                        <p style='margin: 15px 0;'>We detected suspicious file(s):</p>
                        ${fileListHTML}
                        <p style="margin-top: 12px; font-size: 13px; color: #ddd;">
                            You can quarantine, download for analysis, or permanently delete these files from the server.
                        </p>
                    `,
                    icon: "warning",
                    showCancelButton: true,
                    showDenyButton: true,
                    confirmButtonText: "Delete files permanently",
                    denyButtonText: "Quarantine (keep)",
                    cancelButtonText: "Close",
                    confirmButtonColor: "#ef4444",
                    denyButtonColor: "#f59e0b",
                    background: "#1a1a2e",
                    color: "#fff",
                    customClass: { popup: 'swal-custom' }
                }).then((choice) => {
                    // Clear upload area after interaction regardless
                    files = [];
                    fileList.innerHTML = '';
                    scanBtn.classList.remove('show');
                    setTimeout(() => scanBtn.style.display = 'none', 300);

                    if (choice.isConfirmed) {
                        const toDelete = infected
                            .map(f => f.file || (f.path ? f.path.split('/').pop() : null))
                            .filter(Boolean);
                        promptDeleteFiles(toDelete);
                    } else if (choice.isDenied) {
                        const toQuarantine = infected
                            .map(f => f.file || (f.path ? f.path.split('/').pop() : null))
                            .filter(Boolean);
                        promptQuarantineFiles(toQuarantine);
                    }
                });

            } else {
                Swal.fire({
                    title: "All clear",
                    html: `
                        <p style='margin: 15px 0; font-size: 16px;'>No threats detected. Your files look safe.</p>
                        <p style="margin-top: 10px; font-size: 13px; color: #d1fae5;">
                            Tip: keep important backups and avoid running unknown executables.
                        </p>
                    `,
                    icon: "success",
                    confirmButtonText: "Nice",
                    confirmButtonColor: "#34d399",
                    background: "#1a1a2e",
                    color: "#fff",
                    customClass: { popup: 'swal-custom' }
                }).then(() => {
                    files = [];
                    fileList.innerHTML = '';
                    scanBtn.classList.remove('show');
                    setTimeout(() => scanBtn.style.display = 'none', 300);
                });
            }
        }

        // Ask the user one final time before deleting — clearer wording and consequences
        function promptDeleteFiles(filenames) {
            if (!filenames || filenames.length === 0) {
                Swal.fire({ title: "Nothing to delete", icon: "info", confirmButtonText: "OK" });
                return;
            }

            const listHtml = filenames.map(n => `<li style="text-align:left;">${escapeHtml(n)}</li>`).join("");

            Swal.fire({
                title: "Delete files permanently?",
                html: `
                    <p style="text-align:left; margin-bottom:10px;">This will securely overwrite and remove the following files from the server:</p>
                    <ul style="text-align:left; margin: 0 0 10px 18px;">${listHtml}</ul>
                    <p style="font-size:12px; color:#fca5a5">This action is irreversible.</p>
                `,
                icon: "warning",
                showCancelButton: true,
                confirmButtonText: "Yes, delete permanently",
                cancelButtonText: "No, keep them",
                confirmButtonColor: "#ef4444",
                background: "#1a1a2e",
                color: "#fff"
            }).then((res) => {
                if (res.isConfirmed) {
                    performDelete(filenames);
                }
            });
        }

        // Ask the user before quarantining
        function promptQuarantineFiles(filenames) {
            if (!filenames || filenames.length === 0) {
                Swal.fire({ title: "Nothing to quarantine", icon: "info", confirmButtonText: "OK" });
                return;
            }

            const listHtml = filenames.map(n => `<li style="text-align:left;">${escapeHtml(n)}</li>`).join("");

            Swal.fire({
                title: "Quarantine files?",
                html: `
                    <p style="text-align:left; margin-bottom:10px;">
                        This will move the following files from the uploads folder to the quarantine folder:
                    </p>
                    <ul style="text-align:left; margin: 0 0 10px 18px;">${listHtml}</ul>
                    <p style="font-size:12px; color:#e5e7eb;">
                        Quarantined files are not deleted, but should not be executed.
                    </p>
                `,
                icon: "warning",
                showCancelButton: true,
                confirmButtonText: "Yes, quarantine",
                cancelButtonText: "Cancel",
                confirmButtonColor: "#f59e0b",
                background: "#1a1a2e",
                color: "#fff"
            }).then((res) => {
                if (res.isConfirmed) {
                    performQuarantine(filenames);
                }
            });
        }

        // Call backend to securely delete files
        async function performDelete(filenames) {
            Swal.fire({
                title: "Deleting…",
                html: "Securely removing files from the server. This may take a few seconds.",
                allowOutsideClick: false,
                showConfirmButton: false,
                willOpen: () => {
                    Swal.showLoading();
                },
                background: "#1a1a2e",
                color: "#fff"
            });

            try {
                const res = await fetch("http://localhost:5000/delete_files", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ files: filenames, confirm: true })
                });

                const data = await res.json();

                if (res.ok) {
                    if (Array.isArray(data.deleted) && data.deleted.length > 0) {
                        addDeletedLogs(data.deleted);
                    }

                    Swal.fire({
                        title: "Deleted",
                        html: `<p>${data.deleted.length} file(s) deleted.</p>
                               ${data.failed && data.failed.length ? `<p style="color:#fca5a5">${data.failed.length} failed to delete.</p>` : ""}`,
                        icon: "success",
                        confirmButtonText: "Done",
                        confirmButtonColor: "#34d399",
                        background: "#1a1a2e",
                        color: "#fff"
                    });
                } else {
                    Swal.fire({
                        title: "Delete failed",
                        html: `<p>Server responded with an error.</p><pre style="text-align:left; color:#ddd; font-size:12px;">${JSON.stringify(data, null, 2)}</pre>`,
                        icon: "error",
                        confirmButtonText: "OK",
                        background: "#1a1a2e",
                        color: "#fff"
                    });
                }
            } catch (err) {
                Swal.fire({
                    title: "Network error",
                    text: "Couldn't contact the server to delete files.",
                    icon: "error",
                    confirmButtonText: "OK",
                    background: "#1a1a2e",
                    color: "#fff"
                });
            }
        }

        // Call backend to move files to quarantine folder
        async function performQuarantine(filenames) {
            Swal.fire({
                title: "Quarantining…",
                html: "Moving files to quarantine folder on the server.",
                allowOutsideClick: false,
                showConfirmButton: false,
                willOpen: () => {
                    Swal.showLoading();
                },
                background: "#1a1a2e",
                color: "#fff"
            });

            try {
                const res = await fetch("http://localhost:5000/quarantine_files", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ files: filenames, confirm: true })
                });

                const data = await res.json();

                if (res.ok) {
                    if (Array.isArray(data.quarantined) && data.quarantined.length > 0) {
                        addQuarantineLogs(data.quarantined);
                    }

                    Swal.fire({
                        title: "Quarantined",
                        html: `<p>${data.summary?.quarantined_count || 0} file(s) moved to quarantine.</p>
                               ${data.failed && data.failed.length ? `<p style="color:#fca5a5">${data.failed.length} failed to quarantine.</p>` : ""}`,
                        icon: "success",
                        confirmButtonText: "OK",
                        confirmButtonColor: "#f59e0b",
                        background: "#1a1a2e",
                        color: "#fff"
                    });
                } else {
                    Swal.fire({
                        title: "Quarantine failed",
                        html: `<p>Server responded with an error.</p><pre style="text-align:left; color:#ddd; font-size:12px;">${JSON.stringify(data, null, 2)}</pre>`,
                        icon: "error",
                        confirmButtonText: "OK",
                        background: "#1a1a2e",
                        color: "#fff"
                    });
                }
            } catch (err) {
                Swal.fire({
                    title: "Network error",
                    text: "Couldn't contact the server to quarantine files.",
                    icon: "error",
                    confirmButtonText: "OK",
                    background: "#1a1a2e",
                    color: "#fff"
                });
            }
        }

        // initialize logs count on page load
        updateLogsCount();

        // hook logs link
        const logsLink = document.getElementById('logsLink');
        if (logsLink) logsLink.addEventListener('click', (e) => { 
            e.preventDefault(); 
            showLogsModal(); 
        });

        // Initialize visual effects
        createParticles();
    </script>
</body>
</html>
